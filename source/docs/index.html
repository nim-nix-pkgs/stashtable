<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--  This file is generated by Nim. -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Favicon -->
<link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
<link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA3XAAAN1wFCKJt4AAAAB3RJTUUH4QQQEwksSS9ZWwAAAk1JREFUWMPtll2ITVEUx39nn/O7Y5qR8f05wtCUUr6ZIS++8pEnkZInPImneaCQ5METNdOkeFBKUhMPRIkHKfEuUZSUlGlKPN2TrgfncpvmnntnmlEyq1Z7t89/rf9a6+y99oZxGZf/XeIq61EdtgKXgdXA0xrYAvBjOIF1AI9zvjcC74BSpndrJPkBWDScTF8Aa4E3wDlgHbASaANmVqlcCnwHvgDvgVfAJ+AikAAvgfVZwLnSVZHZaOuKoQi3ZOMi4NkYkpe1p4J7A8BpYAD49hfIy/oqG0+hLomiKP2L5L+1ubn5115S+3OAn4EnwBlgMzCjyt6ZAnQCJ4A7wOs88iRJHvw50HoujuPBoCKwHWiosy8MdfZnAdcHk8dxXFJ3VQbQlCTJvRBCGdRbD4M6uc5glpY3eAihpN5S5w12diSEcCCEcKUO4ljdr15T76ur1FDDLIQQ3qv71EdDOe3Kxj3leRXyk+pxdWnFWod6Wt2bY3de3aSuUHcPBVimHs7mK9WrmeOF6lR1o9qnzskh2ar2qm1qizpfXaPeVGdlmGN5pb09qMxz1Xb1kLqgzn1RyH7JUXW52lr5e/Kqi9qpto7V1atuUzfnARrV7jEib1T76gG2qxdGmXyiekkt1GswPTtek0aBfJp6YySGBfWg2tPQ0FAYgf1stUfdmdcjarbYJEniKIq6gY/Aw+zWHAC+p2labGpqiorFYgGYCEzN7oQdQClN07O1/EfDyGgC0ALMBdYAi4FyK+4H3gLPsxfR1zRNi+NP7nH5J+QntnXe5B5mpfQAAAAASUVORK5CYII=">

<!-- Google fonts -->
<link href='https://fonts.googleapis.com/css?family=Lato:400,600,900' rel='stylesheet' type='text/css'/>
<link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500,600' rel='stylesheet' type='text/css'/>

<!-- CSS -->
<title>stashtable</title>
<link rel="stylesheet" type="text/css" href="nimdoc.out.css">

<script type="text/javascript" src="dochack.js"></script>

<script type="text/javascript">
function main() {
  var pragmaDots = document.getElementsByClassName("pragmadots");
  for (var i = 0; i < pragmaDots.length; i++) {
    pragmaDots[i].onclick = function(event) {
      // Hide tease
      event.target.parentNode.style.display = "none";
      // Show actual
      event.target.parentNode.nextElementSibling.style.display = "inline";
    }
  }

  const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');
  function switchTheme(e) {
      if (e.target.checked) {
          document.documentElement.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
      } else {
          document.documentElement.setAttribute('data-theme', 'light');
          localStorage.setItem('theme', 'light');
      }
  }

  toggleSwitch.addEventListener('change', switchTheme, false);

  const currentTheme = localStorage.getItem('theme') ? localStorage.getItem('theme') : null;
  if (currentTheme) {
    document.documentElement.setAttribute('data-theme', currentTheme);

    if (currentTheme === 'dark') {
      toggleSwitch.checked = true;
    }
  }
}
</script>

</head>
<body onload="main()">
<div class="document" id="documentId">
  <div class="container">
    <h1 class="title">stashtable</h1>
    <div class="row">
  <div class="three columns">
  <div class="theme-switch-wrapper">
    <label class="theme-switch" for="checkbox">
      <input type="checkbox" id="checkbox" />
      <div class="slider round"></div>
    </label>
    &nbsp;&nbsp;&nbsp; <em>Dark Mode</em>
  </div>
  <div id="global-links">
    <ul class="simple">
    <li>
      <a href="theindex.html">Index</a>
    </li>
    </ul>
  </div>
  <div id="searchInputDiv">
    Search: <input type="text" id="searchInput"
      onkeyup="search()" />
  </div>
  <div>
    Group by:
    <select onchange="groupBy(this.value)">
      <option value="section">Section</option>
      <option value="type">Type</option>
    </select>
  </div>
  <ul class="simple simple-toc" id="toc-list">
<li><a class="reference" id="basic-usage_toc" href="#basic-usage">Basic usage</a></li>
<li><a class="reference" id="see-also_toc" href="#see-also">See also</a></li>
<li>
  <a class="reference reference-toplevel" href="#7" id="57">Types</a>
  <ul class="simple simple-toc-section">
      <li><a class="reference" href="#Index"
    title="Index = distinct int">Index</a></li>
  <li><a class="reference" href="#StashTable"
    title="StashTable[K; V; Capacity] = ref StashTableObject[K, V, Capacity]">StashTable</a></li>

  </ul>
</li>
<li>
  <a class="reference reference-toplevel" href="#10" id="60">Consts</a>
  <ul class="simple simple-toc-section">
      <li><a class="reference" href="#NotInStash"
    title="NotInStash = -2147483647">NotInStash</a></li>

  </ul>
</li>
<li>
  <a class="reference reference-toplevel" href="#12" id="62">Procs</a>
  <ul class="simple simple-toc-section">
      <ul class="simple nested-toc-section">$
      <li><a class="reference" href="#%24%2CIndex"
    title="`$`(index: Index): string">$,<wbr>Index</a></li>
  <li><a class="reference" href="#%24%2CStashTable"
    title="`$`(stash: StashTable): string">$,<wbr>StashTable</a></li>

  </ul>
  <ul class="simple nested-toc-section">findIndex
      <li><a class="reference" href="#findIndex%2CStashTable%5BK%2CV%2CCapacity%5D%2CK"
    title="findIndex[K, V, Capacity](stash: StashTable[K, V, Capacity]; key: K): Index">findIndex,<wbr>StashTable[K,<wbr>V,<wbr>Capacity],<wbr>K</a></li>

  </ul>
  <ul class="simple nested-toc-section">del
      <li><a class="reference" href="#del%2CStashTable%5BK%2CV%2CCapacity%5D%2CK"
    title="del[K, V, Capacity](stash: StashTable[K, V, Capacity]; key: K)">del,<wbr>StashTable[K,<wbr>V,<wbr>Capacity],<wbr>K</a></li>

  </ul>
  <ul class="simple nested-toc-section">[]=
      <li><a class="reference" href="#%5B%5D%3D%2CStashTable%5BK%2CV%2CCapacity%5D%2CK%2CV"
    title="`[]=`[K, V, Capacity](stash: StashTable[K, V, Capacity]; key: K; value: V)">[]=,<wbr>StashTable[K,<wbr>V,<wbr>Capacity],<wbr>K,<wbr>V</a></li>

  </ul>
  <ul class="simple nested-toc-section">upsert
      <li><a class="reference" href="#upsert%2CStashTable%5BK%2CV%2CCapacity%5D%2CK%2CV"
    title="upsert[K, V, Capacity](stash: StashTable[K, V, Capacity]; key: K; value: V): (
    Index, bool)">upsert,<wbr>StashTable[K,<wbr>V,<wbr>Capacity],<wbr>K,<wbr>V</a></li>

  </ul>
  <ul class="simple nested-toc-section">len
      <li><a class="reference" href="#len%2CStashTable"
    title="len(stash: StashTable): int">len,<wbr>StashTable</a></li>

  </ul>
  <ul class="simple nested-toc-section">newStashTable
      <li><a class="reference" href="#newStashTable"
    title="newStashTable[K; V; Capacity: static int](): StashTable[K, V, Capacity]">newStashTable</a></li>

  </ul>
  <ul class="simple nested-toc-section">insert
      <li><a class="reference" href="#insert%2CStashTable%5BK%2CV%2CCapacity%5D%2CK%2CV"
    title="insert[K, V, Capacity](stash: StashTable[K, V, Capacity]; key: K; value: V): (
    Index, bool)">insert,<wbr>StashTable[K,<wbr>V,<wbr>Capacity],<wbr>K,<wbr>V</a></li>

  </ul>
  <ul class="simple nested-toc-section">=destroy
      <li><a class="reference" href="#%3Ddestroy%2CStashTableObject%5BK%2CV%2CCapacity%5D"
    title="`=destroy`[K, V, Capacity](stash: var StashTableObject[K, V, Capacity])">=destroy,<wbr>StashTableObject[K,<wbr>V,<wbr>Capacity]</a></li>

  </ul>
  <ul class="simple nested-toc-section">clear
      <li><a class="reference" href="#clear%2CStashTable%5BK%2CV%2CCapacity%5D"
    title="clear[K, V, Capacity](stash: StashTable[K, V, Capacity])">clear,<wbr>StashTable[K,<wbr>V,<wbr>Capacity]</a></li>

  </ul>
  <ul class="simple nested-toc-section">addAll
      <li><a class="reference" href="#addAll%2CStashTable%5BK%2CV%2CCapacity1%5D%2CStashTable%5BK%2CV%2CCapacity2%5D%2Cbool"
    title="addAll[K; V; Capacity1: static int; Capacity2: static int](
    toStashTable: StashTable[K, V, Capacity1];
    fromStashTable: StashTable[K, V, Capacity2]; upsert: bool): bool">addAll,<wbr>StashTable[K,<wbr>V,<wbr>Capacity1],<wbr>StashTable[K,<wbr>V,<wbr>Capacity2],<wbr>bool</a></li>

  </ul>
  <ul class="simple nested-toc-section">==
      <li><a class="reference" href="#%3D%3D%2CIndex%2CIndex"
    title="`==`(x, y: Index): bool">==,<wbr>Index,<wbr>Index</a></li>

  </ul>

  </ul>
</li>
<li>
  <a class="reference reference-toplevel" href="#15" id="65">Iterators</a>
  <ul class="simple simple-toc-section">
      <li><a class="reference" href="#keys.i%2CStashTable%5BK%2CV%2CCapacity%5D"
    title="keys[K, V, Capacity](stash: StashTable[K, V, Capacity]): (K, Index)">keys</a></li>

  </ul>
</li>
<li>
  <a class="reference reference-toplevel" href="#18" id="68">Templates</a>
  <ul class="simple simple-toc-section">
      <li><a class="reference" href="#withFound.t%2CStashTable%5BK%2CV%2CCapacity%5D%2CK%2CIndex%2Cuntyped"
    title="withFound[K; V; Capacity](stash: StashTable[K, V, Capacity]; thekey: K;
                          theindex: Index; body: untyped)">withFound</a></li>
  <li><a class="reference" href="#withValue.t%2CStashTable%5BK%2CV%2CCapacity%5D%2CK%2Cuntyped%2Cuntyped"
    title="withValue[K; V; Capacity](stash: StashTable[K, V, Capacity]; thekey: K;
                          body1, body2: untyped)">withValue</a></li>
  <li><a class="reference" href="#withValue.t%2CStashTable%5BK%2CV%2CCapacity%5D%2CK%2Cuntyped"
    title="withValue[K; V; Capacity](stash: StashTable[K, V, Capacity]; thekey: K;
                          body: untyped)">withValue</a></li>

  </ul>
</li>

</ul>

  </div>
  <div class="nine columns" id="content">
  <div id="tocRoot"></div>
  
  <p class="module-desc"><p><tt class="docutils literal"><span class="pre">StashTable</span></tt> is a space- and time-efficient generic concurrent hash table (also often named map or dictionary in other programming languages) that is a mapping from keys to values.</p>
<p>Thanks to it's unique collision resolution strategy, StashTable provides following key features:</p>
<ul class="simple"><li>O(1) amortized parallel reads and writes</li>
<li>O(1) worst-case serialized inserts</li>
<li>O(1) amortized serialized deletes</li>
<li>Fast, cache-friendly iterating that does not block and is not blocked by any other operation</li>
</ul>
<p>API in a nutshell:</p>
<ul class="simple"><li><a class="reference external" href="#keys.i%2CStashTable%5BK%2CV%2CCapacity%5D">keys</a> iterator to access all items</li>
<li><a class="reference external" href="#withValue.t%2CStashTable%5BK%2CV%2CCapacity%5D%2CK%2Cuntyped%2Cuntyped">withValue</a> and <a class="reference external" href="#withFound.t%2CStashTable%5BK%2CV%2CCapacity%5D%2CK%2CIndex%2Cuntyped">withFound</a> templates lock access to a single item but any other operation can proceed in parallel</li>
<li>other operations (<a class="reference external" href="#len%2CStashTable">len</a>, <a class="reference external" href="#insert%2CStashTable%5BK%2CV%2CCapacity%5D%2CK%2CV">insert</a>, <a class="reference external" href="#upsert%2CStashTable%5BK%2CV%2CCapacity%5D%2CK%2CV">upsert</a>, <a class="reference external" href="#addAll%2CStashTable%5BK%2CV%2CCapacity1%5D%2CStashTable%5BK%2CV%2CCapacity2%5D%2Cbool">addAll</a>, <a class="reference external" href="#addAll%2CStashTable%5BK%2CV%2CCapacity1%5D%2CStashTable%5BK%2CV%2CCapacity2%5D%2Cbool">del</a>, and <a class="reference external" href="#clear%2CStashTable%5BK%2CV%2CCapacity%5D">clear</a>) will block each other</li>
</ul>
<p>caveats:</p>
<ul class="simple"><li>Because iterating does not block, aggregate functions do not give consistent answers if other threads are modifying the table</li>
<li><tt class="docutils literal"><span class="pre">withValue</span></tt> or <tt class="docutils literal"><span class="pre">withFound</span></tt> calls cannot be nested, unless always in same key order. Otherwise a deadlock is bound to occur</li>
<li>A blocking operation cannot be called from inside <tt class="docutils literal"><span class="pre">withValue</span></tt> or <tt class="docutils literal"><span class="pre">withFound</span></tt>. Otherwise a deadlock is bound to occur</li>
<li>Strings, seqs or refs in keys or values requires --gc:arc or --gc:orc</li>
</ul>
<p>StashTable has <a class="reference external" href="https://nim-lang.org/docs/manual.html#types-reference-and-pointer-types">ref semantics</a>.</p>

<h1><a class="toc-backref" id="basic-usage" href="#basic-usage">Basic usage</a></h1><pre class="listing"><span class="Keyword">import</span> <span class="Identifier">stashtable</span>
<span class="Keyword">from</span> <span class="Identifier">sequtils</span> <span class="Keyword">import</span> <span class="Identifier">zip</span>

<span class="Keyword">let</span>
  <span class="Identifier">names</span> <span class="Operator">=</span> <span class="Punctuation">[</span><span class="StringLit">&quot;John&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;Paul&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;George&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;Ringo&quot;</span><span class="Punctuation">]</span>
  <span class="Identifier">years</span> <span class="Operator">=</span> <span class="Punctuation">[</span><span class="DecNumber">1940</span><span class="Punctuation">,</span> <span class="DecNumber">1942</span><span class="Punctuation">,</span> <span class="DecNumber">1943</span><span class="Punctuation">,</span> <span class="DecNumber">1940</span><span class="Punctuation">]</span>
  <span class="Identifier">beatles</span> <span class="Operator">=</span> <span class="Identifier">newStashTable</span><span class="Punctuation">[</span><span class="Identifier">string</span><span class="Punctuation">,</span> <span class="Identifier">int</span><span class="Punctuation">,</span> <span class="Identifier">names</span><span class="Operator">.</span><span class="Identifier">len</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Punctuation">)</span>

<span class="Keyword">for</span> <span class="Punctuation">(</span><span class="Identifier">name</span> <span class="Punctuation">,</span> <span class="Identifier">birthYear</span><span class="Punctuation">)</span> <span class="Keyword">in</span> <span class="Identifier">zip</span><span class="Punctuation">(</span><span class="Identifier">names</span><span class="Punctuation">,</span> <span class="Identifier">years</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
  <span class="Identifier">beatles</span><span class="Punctuation">[</span><span class="Identifier">name</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">birthYear</span>

<span class="Identifier">echo</span> <span class="Identifier">beatles</span>
<span class="Identifier">doAssert</span> <span class="Operator">$</span><span class="Identifier">beatles</span> <span class="Operator">==</span> <span class="LongStringLit">&quot;&quot;&quot;{&quot;John&quot;: 1940, &quot;Paul&quot;: 1942, &quot;George&quot;: 1943, &quot;Ringo&quot;: 1940}&quot;&quot;&quot;</span>

<span class="Keyword">let</span> <span class="Identifier">beatlesByYear</span> <span class="Operator">=</span> <span class="Identifier">newStashTable</span><span class="Punctuation">[</span><span class="Identifier">int</span><span class="Punctuation">,</span> <span class="Identifier">seq</span><span class="Punctuation">[</span><span class="Identifier">string</span><span class="Punctuation">]</span><span class="Punctuation">,</span> <span class="Identifier">names</span><span class="Operator">.</span><span class="Identifier">len</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Punctuation">)</span>

<span class="Keyword">for</span> <span class="Punctuation">(</span><span class="Identifier">birthYear</span> <span class="Punctuation">,</span> <span class="Identifier">name</span><span class="Punctuation">)</span> <span class="Keyword">in</span> <span class="Identifier">zip</span><span class="Punctuation">(</span><span class="Identifier">years</span><span class="Punctuation">,</span> <span class="Identifier">names</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
  <span class="Identifier">beatlesByYear</span><span class="Operator">.</span><span class="Identifier">withValue</span><span class="Punctuation">(</span><span class="Identifier">birthYear</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
    <span class="Identifier">value</span><span class="Punctuation">[</span><span class="Punctuation">]</span><span class="Operator">.</span><span class="Identifier">add</span><span class="Punctuation">(</span><span class="Identifier">name</span><span class="Punctuation">)</span>
  <span class="Keyword">do</span><span class="Punctuation">:</span>
    <span class="Comment"># key doesn't exist, we create one</span>
    <span class="Keyword">discard</span> <span class="Identifier">beatlesByYear</span><span class="Operator">.</span><span class="Identifier">insert</span><span class="Punctuation">(</span><span class="Identifier">birthYear</span><span class="Punctuation">,</span> <span class="Operator">@</span><span class="Punctuation">[</span><span class="Identifier">name</span><span class="Punctuation">]</span><span class="Punctuation">)</span>

<span class="Identifier">echo</span> <span class="Identifier">beatlesByYear</span>
<span class="Identifier">doAssert</span> <span class="Operator">$</span><span class="Identifier">beatlesByYear</span> <span class="Operator">==</span> <span class="LongStringLit">&quot;&quot;&quot;{1940: @[&quot;John&quot;, &quot;Ringo&quot;], 1942: @[&quot;Paul&quot;], 1943: @[&quot;George&quot;]}&quot;&quot;&quot;</span></pre>
<h1><a class="toc-backref" id="see-also" href="#see-also">See also</a></h1><p><a class="reference external" href="https://nim-lang.org/docs/sharedtables.html">sharedtables</a> <a class="reference external" href="https://nim-lang.org/docs/tables.html">tables</a> <a class="reference external" href="https://nim-lang.org/docs/hashes.html">hashes</a> <a class="reference external" href="https://github.com/olliNiinivaara/Nichecache">nichecache</a></p>
</p>
  <div class="section" id="7">
<h1><a class="toc-backref" href="#7">Types</a></h1>
<dl class="item">
<a id="Index"></a>
<dt><pre><a href="stashtable.html#Index"><span class="Identifier">Index</span></a> <span class="Other">=</span> <span class="Keyword">distinct</span> <span class="Identifier">int</span></pre></dt>
<dd>

Index to an item (item = key-value pair). Other threads may delete or move the item until it's locked with <tt class="docutils literal"><span class="pre">withFound</span></tt> template.

</dd>
<a id="StashTable"></a>
<dt><pre><a href="stashtable.html#StashTable"><span class="Identifier">StashTable</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">;</span> <span class="Identifier">V</span><span class="Other">;</span> <span class="Identifier">Capacity</span><span class="Other">]</span> <span class="Other">=</span> <span class="Keyword">ref</span> <span class="Identifier">StashTableObject</span><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity</span><span class="Other">]</span></pre></dt>
<dd>

Generic thread-safe hash table.

</dd>

</dl></div>
<div class="section" id="10">
<h1><a class="toc-backref" href="#10">Consts</a></h1>
<dl class="item">
<a id="NotInStash"></a>
<dt><pre><a href="stashtable.html#NotInStash"><span class="Identifier">NotInStash</span></a> <span class="Other">=</span> <span class="DecNumber">-2147483647</span></pre></dt>
<dd>

Index for keys not in the table.

</dd>

</dl></div>
<div class="section" id="12">
<h1><a class="toc-backref" href="#12">Procs</a></h1>
<dl class="item">
<a id="newStashTable"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#newStashTable"><span class="Identifier">newStashTable</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">;</span> <span class="Identifier">V</span><span class="Other">;</span> <span class="Identifier">Capacity</span><span class="Other">:</span> <span class="Identifier">static</span> <span class="Identifier">int</span><span class="Other">]</span><span class="Other">(</span><span class="Other">)</span><span class="Other">:</span> <a href="stashtable.html#StashTable"><span class="Identifier">StashTable</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity</span><span class="Other">]</span></pre></dt>
<dd>

<p>Creates a new hash table that is empty.</p>
<p>After maximum capacity is reached, inserts and upserts will start returning <tt class="docutils literal"><span class="pre">NotInStash</span></tt>. If you need to grow the capacity, create a new larger table, copy items to it with <tt class="docutils literal"><span class="pre">addAll</span></tt> proc and switch reference(s).</p>
<p>Recommended practice is to reserve enough capacity right at initialisation, because</p>
<ul class="simple"><li>StashTable is very space-efficient anyway (especially when using pointers as values)</li>
<li><tt class="docutils literal"><span class="pre">addAll</span></tt> takes some time and blocked operations will naturally not be reflected in new table.</li>
<li><tt class="docutils literal"><span class="pre">addAll</span></tt> will temporarily need enough memory to hold both old <strong><em>and</em></strong> new table</li>
<li>Last but not least: all extra capacity will speed up execution by lowering probability of hash collisions</li>
</ul>


</dd>
<a id="=destroy,StashTableObject[K,V,Capacity]"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#%3Ddestroy%2CStashTableObject%5BK%2CV%2CCapacity%5D"><span class="Identifier">`=destroy`</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">stash</span><span class="Other">:</span> <span class="Keyword">var</span> <span class="Identifier">StashTableObject</span><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity</span><span class="Other">]</span><span class="Other">)</span></pre></dt>
<dd>

Releases OS resources reserved by locks.

</dd>
<a id="==,Index,Index"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#%3D%3D%2CIndex%2CIndex"><span class="Identifier">`==`</span></a><span class="Other">(</span><span class="Identifier">x</span><span class="Other">,</span> <span class="Identifier">y</span><span class="Other">:</span> <a href="stashtable.html#Index"><span class="Identifier">Index</span></a><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">bool</span> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">borrow</span></span><span class="Other">.}</span></span></pre></dt>
<dd>



</dd>
<a id="$,Index"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#%24%2CIndex"><span class="Identifier">`$`</span></a><span class="Other">(</span><span class="Identifier">index</span><span class="Other">:</span> <a href="stashtable.html#Index"><span class="Identifier">Index</span></a><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">string</span> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">,</span> <span class="Identifier">tags</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span><span class="Other">.}</span></span></pre></dt>
<dd>



</dd>
<a id="len,StashTable"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#len%2CStashTable"><span class="Identifier">len</span></a><span class="Other">(</span><span class="Identifier">stash</span><span class="Other">:</span> <a href="stashtable.html#StashTable"><span class="Identifier">StashTable</span></a><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">int</span> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">inline</span></span><span class="Other">.}</span></span></pre></dt>
<dd>

Returns the number of keys in <tt class="docutils literal"><span class="pre">stash</span></tt>.

</dd>
<a id="findIndex,StashTable[K,V,Capacity],K"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#findIndex%2CStashTable%5BK%2CV%2CCapacity%5D%2CK"><span class="Identifier">findIndex</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">stash</span><span class="Other">:</span> <a href="stashtable.html#StashTable"><span class="Identifier">StashTable</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity</span><span class="Other">]</span><span class="Other">;</span> <span class="Identifier">key</span><span class="Other">:</span> <span class="Identifier">K</span><span class="Other">)</span><span class="Other">:</span> <a href="stashtable.html#Index"><span class="Identifier">Index</span></a></pre></dt>
<dd>

Returns <tt class="docutils literal"><span class="pre">Index</span></tt> for given <tt class="docutils literal"><span class="pre">key</span></tt>, or <tt class="docutils literal"><span class="pre">NotInStash</span></tt> if key was not in <tt class="docutils literal"><span class="pre">stash</span></tt>. Note that the returned <tt class="docutils literal"><span class="pre">Index</span></tt> may be invalidated at any moment by other threads.

</dd>
<a id="$,StashTable"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#%24%2CStashTable"><span class="Identifier">`$`</span></a><span class="Other">(</span><span class="Identifier">stash</span><span class="Other">:</span> <a href="stashtable.html#StashTable"><span class="Identifier">StashTable</span></a><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">string</span></pre></dt>
<dd>



</dd>
<a id="insert,StashTable[K,V,Capacity],K,V"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#insert%2CStashTable%5BK%2CV%2CCapacity%5D%2CK%2CV"><span class="Identifier">insert</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">stash</span><span class="Other">:</span> <a href="stashtable.html#StashTable"><span class="Identifier">StashTable</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity</span><span class="Other">]</span><span class="Other">;</span> <span class="Identifier">key</span><span class="Other">:</span> <span class="Identifier">K</span><span class="Other">;</span> <span class="Identifier">value</span><span class="Other">:</span> <span class="Identifier">V</span><span class="Other">)</span><span class="Other">:</span> <span class="Other">(</span>
    <a href="stashtable.html#Index"><span class="Identifier">Index</span></a><span class="Other">,</span> <span class="Identifier">bool</span><span class="Other">)</span> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">discardable</span></span><span class="Other">.}</span></span></pre></dt>
<dd>

Inserts a <tt class="docutils literal"><span class="pre">(key, value)</span></tt> pair into <tt class="docutils literal"><span class="pre">stash</span></tt>. Returns a tuple with following information:<ul class="simple"><li><tt class="docutils literal"><span class="pre">(i , true)</span></tt> : The item was succesfully inserted to Index i</li>
<li><tt class="docutils literal"><span class="pre">(i , false)</span></tt> : The item was not inserted because there was already item with the same <tt class="docutils literal"><span class="pre">key</span></tt> at Index i</li>
<li><tt class="docutils literal"><span class="pre">(NotInStash , false)</span></tt> : The item was not inserted because <tt class="docutils literal"><span class="pre">stash</span></tt> was full, i.e. <tt class="docutils literal"><span class="pre">len</span></tt> == <tt class="docutils literal"><span class="pre">Capacity</span></tt></li>
</ul>

<p><strong class="examples_text">Example:</strong></p>
<pre class="listing"><span class="Keyword">let</span><span class="Whitespace"> </span><span class="Identifier">a</span><span class="Whitespace"> </span><span class="Operator">=</span><span class="Whitespace"> </span><span class="Identifier">newStashTable</span><span class="Punctuation">[</span><span class="Identifier">char</span><span class="Punctuation">,</span><span class="Whitespace"> </span><span class="Identifier">int</span><span class="Punctuation">,</span><span class="Whitespace"> </span><span class="DecNumber">1024</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Whitespace">  
</span><span class="Keyword">let</span><span class="Whitespace"> </span><span class="Punctuation">(</span><span class="Identifier">index1</span><span class="Punctuation">,</span><span class="Whitespace"> </span><span class="Identifier">wasinserted1</span><span class="Punctuation">)</span><span class="Whitespace"> </span><span class="Operator">=</span><span class="Whitespace"> </span><span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">insert</span><span class="Punctuation">(</span><span class="CharLit">&apos;x&apos;</span><span class="Punctuation">,</span><span class="Whitespace"> </span><span class="DecNumber">7</span><span class="Punctuation">)</span><span class="Whitespace">
</span><span class="Identifier">doAssert</span><span class="Whitespace"> </span><span class="Identifier">wasinserted1</span><span class="Whitespace">
</span><span class="Keyword">let</span><span class="Whitespace"> </span><span class="Punctuation">(</span><span class="Identifier">index2</span><span class="Punctuation">,</span><span class="Whitespace"> </span><span class="Identifier">wasinserted2</span><span class="Punctuation">)</span><span class="Whitespace"> </span><span class="Operator">=</span><span class="Whitespace"> </span><span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">insert</span><span class="Punctuation">(</span><span class="CharLit">&apos;x&apos;</span><span class="Punctuation">,</span><span class="Whitespace"> </span><span class="DecNumber">33</span><span class="Punctuation">)</span><span class="Whitespace">
</span><span class="Identifier">doAssert</span><span class="Whitespace"> </span><span class="Identifier">index2</span><span class="Whitespace"> </span><span class="Operator">==</span><span class="Whitespace"> </span><span class="Identifier">index1</span><span class="Whitespace"> </span><span class="Keyword">and</span><span class="Whitespace"> </span><span class="Keyword">not</span><span class="Whitespace"> </span><span class="Identifier">wasinserted2</span></pre>

</dd>
<a id="upsert,StashTable[K,V,Capacity],K,V"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#upsert%2CStashTable%5BK%2CV%2CCapacity%5D%2CK%2CV"><span class="Identifier">upsert</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">stash</span><span class="Other">:</span> <a href="stashtable.html#StashTable"><span class="Identifier">StashTable</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity</span><span class="Other">]</span><span class="Other">;</span> <span class="Identifier">key</span><span class="Other">:</span> <span class="Identifier">K</span><span class="Other">;</span> <span class="Identifier">value</span><span class="Other">:</span> <span class="Identifier">V</span><span class="Other">)</span><span class="Other">:</span> <span class="Other">(</span>
    <a href="stashtable.html#Index"><span class="Identifier">Index</span></a><span class="Other">,</span> <span class="Identifier">bool</span><span class="Other">)</span></pre></dt>
<dd>

Updates value at <tt class="docutils literal"><span class="pre">stash[key]</span></tt> or inserts item if <tt class="docutils literal"><span class="pre">key</span></tt> not present. Returns a tuple with following information:<ul class="simple"><li><tt class="docutils literal"><span class="pre">(i , true)</span></tt> : The item was succesfully inserted to Index i</li>
<li><tt class="docutils literal"><span class="pre">(i , false)</span></tt> : The item already existed at Index i and it's value was updated to given <tt class="docutils literal"><span class="pre">value</span></tt></li>
<li><tt class="docutils literal"><span class="pre">(NotInStash , false)</span></tt> : The key did not exist but the item could not be inserted because <tt class="docutils literal"><span class="pre">stash</span></tt> was full</li>
</ul>


</dd>
<a id="[]=,StashTable[K,V,Capacity],K,V"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#%5B%5D%3D%2CStashTable%5BK%2CV%2CCapacity%5D%2CK%2CV"><span class="Identifier">`[]=`</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">stash</span><span class="Other">:</span> <a href="stashtable.html#StashTable"><span class="Identifier">StashTable</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity</span><span class="Other">]</span><span class="Other">;</span> <span class="Identifier">key</span><span class="Other">:</span> <span class="Identifier">K</span><span class="Other">;</span> <span class="Identifier">value</span><span class="Other">:</span> <span class="Identifier">V</span><span class="Other">)</span></pre></dt>
<dd>

Executes <tt class="docutils literal"><span class="pre">upsert</span></tt> and silently discards the result.

</dd>
<a id="addAll,StashTable[K,V,Capacity1],StashTable[K,V,Capacity2],bool"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#addAll%2CStashTable%5BK%2CV%2CCapacity1%5D%2CStashTable%5BK%2CV%2CCapacity2%5D%2Cbool"><span class="Identifier">addAll</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">;</span> <span class="Identifier">V</span><span class="Other">;</span> <span class="Identifier">Capacity1</span><span class="Other">:</span> <span class="Identifier">static</span> <span class="Identifier">int</span><span class="Other">;</span> <span class="Identifier">Capacity2</span><span class="Other">:</span> <span class="Identifier">static</span> <span class="Identifier">int</span><span class="Other">]</span><span class="Other">(</span>
    <span class="Identifier">toStashTable</span><span class="Other">:</span> <a href="stashtable.html#StashTable"><span class="Identifier">StashTable</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity1</span><span class="Other">]</span><span class="Other">;</span>
    <span class="Identifier">fromStashTable</span><span class="Other">:</span> <a href="stashtable.html#StashTable"><span class="Identifier">StashTable</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity2</span><span class="Other">]</span><span class="Other">;</span> <span class="Identifier">upsert</span><span class="Other">:</span> <span class="Identifier">bool</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">bool</span></pre></dt>
<dd>

Copies all items from <tt class="docutils literal"><span class="pre">fromStashTable</span></tt> to <tt class="docutils literal"><span class="pre">toStashTable</span></tt>. <tt class="docutils literal"><span class="pre">upsert</span></tt> parameter tells whether existing keys will be updated or skipped. Returns false if could not add all because capacity filled up.

</dd>
<a id="del,StashTable[K,V,Capacity],K"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#del%2CStashTable%5BK%2CV%2CCapacity%5D%2CK"><span class="Identifier">del</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">stash</span><span class="Other">:</span> <a href="stashtable.html#StashTable"><span class="Identifier">StashTable</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity</span><span class="Other">]</span><span class="Other">;</span> <span class="Identifier">key</span><span class="Other">:</span> <span class="Identifier">K</span><span class="Other">)</span></pre></dt>
<dd>

<p>Deletes <tt class="docutils literal"><span class="pre">key</span></tt> from <tt class="docutils literal"><span class="pre">stash</span></tt>. Does nothing if the key does not exist.</p>
<p>Note that <tt class="docutils literal"><span class="pre">del</span></tt> must not be called from inside a <tt class="docutils literal"><span class="pre">withValue</span></tt> or <tt class="docutils literal"><span class="pre">withFound</span></tt> block. Instead, write down the <tt class="docutils literal"><span class="pre">key</span></tt> and call <tt class="docutils literal"><span class="pre">del</span></tt> afterwards.</p>
<pre class="listing"><span class="Keyword">let</span> <span class="Identifier">s</span> <span class="Operator">=</span> <span class="Identifier">newStashTable</span><span class="Punctuation">[</span><span class="Identifier">int</span><span class="Punctuation">,</span> <span class="Identifier">char</span><span class="Punctuation">,</span> <span class="DecNumber">4</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
<span class="Keyword">var</span> <span class="Identifier">deletables</span><span class="Punctuation">:</span> <span class="Identifier">seq</span><span class="Punctuation">[</span><span class="Identifier">int</span><span class="Punctuation">]</span>
<span class="Identifier">s</span><span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="CharLit">'a'</span> <span class="Punctuation">;</span> <span class="Identifier">s</span><span class="Punctuation">[</span><span class="DecNumber">2</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="CharLit">'b'</span> <span class="Punctuation">;</span> <span class="Identifier">s</span><span class="Punctuation">[</span><span class="DecNumber">3</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="CharLit">'a'</span>
<span class="Identifier">doAssert</span> <span class="Identifier">s</span><span class="Operator">.</span><span class="Identifier">len</span> <span class="Operator">==</span> <span class="DecNumber">3</span>
<span class="Keyword">for</span> <span class="Punctuation">(</span><span class="Identifier">key</span><span class="Punctuation">,</span> <span class="Identifier">index</span><span class="Punctuation">)</span> <span class="Keyword">in</span> <span class="Identifier">s</span><span class="Operator">.</span><span class="Identifier">keys</span><span class="Punctuation">:</span>
  <span class="Identifier">s</span><span class="Operator">.</span><span class="Identifier">withFound</span><span class="Punctuation">(</span><span class="Identifier">key</span><span class="Punctuation">,</span> <span class="Identifier">index</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
    <span class="Keyword">if</span> <span class="Identifier">value</span><span class="Punctuation">[</span><span class="Punctuation">]</span> <span class="Operator">!=</span> <span class="CharLit">'b'</span><span class="Punctuation">:</span> <span class="Identifier">deletables</span><span class="Operator">.</span><span class="Identifier">add</span><span class="Punctuation">(</span><span class="Identifier">key</span><span class="Punctuation">)</span>
<span class="Keyword">for</span> <span class="Identifier">key</span> <span class="Keyword">in</span> <span class="Identifier">deletables</span><span class="Punctuation">:</span> <span class="Identifier">s</span><span class="Operator">.</span><span class="Identifier">del</span><span class="Punctuation">(</span><span class="Identifier">key</span><span class="Punctuation">)</span>
<span class="Identifier">doAssert</span> <span class="Identifier">s</span><span class="Operator">.</span><span class="Identifier">len</span> <span class="Operator">==</span> <span class="DecNumber">1</span></pre>

</dd>
<a id="clear,StashTable[K,V,Capacity]"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#clear%2CStashTable%5BK%2CV%2CCapacity%5D"><span class="Identifier">clear</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">stash</span><span class="Other">:</span> <a href="stashtable.html#StashTable"><span class="Identifier">StashTable</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity</span><span class="Other">]</span><span class="Other">)</span></pre></dt>
<dd>

Resets the stash so that it is empty.

</dd>

</dl></div>
<div class="section" id="15">
<h1><a class="toc-backref" href="#15">Iterators</a></h1>
<dl class="item">
<a id="keys.i,StashTable[K,V,Capacity]"></a>
<dt><pre><span class="Keyword">iterator</span> <a href="#keys.i%2CStashTable%5BK%2CV%2CCapacity%5D"><span class="Identifier">keys</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">stash</span><span class="Other">:</span> <a href="stashtable.html#StashTable"><span class="Identifier">StashTable</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity</span><span class="Other">]</span><span class="Other">)</span><span class="Other">:</span> <span class="Other">(</span><span class="Identifier">K</span><span class="Other">,</span> <a href="stashtable.html#Index"><span class="Identifier">Index</span></a><span class="Other">)</span></pre></dt>
<dd>

<p>Iterates over all <tt class="docutils literal"><span class="pre">(key , index)</span></tt> pairs in the table <tt class="docutils literal"><span class="pre">stash</span></tt>.</p>
<p>feature: if there are no deletes, iteration order is insertion order.</p>
<pre class="listing"><span class="Keyword">let</span> <span class="Identifier">a</span> <span class="Operator">=</span> <span class="Identifier">newStashTable</span><span class="Punctuation">[</span><span class="Identifier">char</span><span class="Punctuation">,</span> <span class="Identifier">array</span><span class="Punctuation">[</span><span class="DecNumber">4</span><span class="Punctuation">,</span> <span class="Identifier">int</span><span class="Punctuation">]</span><span class="Punctuation">,</span> <span class="DecNumber">128</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
<span class="Identifier">a</span><span class="Punctuation">[</span><span class="CharLit">'o'</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">5</span><span class="Punctuation">,</span> <span class="DecNumber">7</span><span class="Punctuation">,</span> <span class="DecNumber">9</span><span class="Punctuation">]</span>
<span class="Identifier">a</span><span class="Punctuation">[</span><span class="CharLit">'e'</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Punctuation">[</span><span class="DecNumber">2</span><span class="Punctuation">,</span> <span class="DecNumber">4</span><span class="Punctuation">,</span> <span class="DecNumber">6</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">]</span>
<span class="Keyword">for</span> <span class="Punctuation">(</span><span class="Identifier">k</span> <span class="Punctuation">,</span> <span class="Identifier">index</span><span class="Punctuation">)</span> <span class="Keyword">in</span> <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">keys</span><span class="Punctuation">:</span>
  <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">withFound</span><span class="Punctuation">(</span><span class="Identifier">k</span><span class="Punctuation">,</span> <span class="Identifier">index</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
    <span class="Identifier">echo</span> <span class="StringLit">&quot;key: &quot;</span><span class="Punctuation">,</span> <span class="Identifier">k</span>
    <span class="Identifier">echo</span> <span class="StringLit">&quot;value: &quot;</span><span class="Punctuation">,</span> <span class="Identifier">value</span><span class="Punctuation">[</span><span class="Punctuation">]</span>
    <span class="Identifier">doAssert</span> <span class="Punctuation">(</span><span class="Identifier">k</span> <span class="Operator">==</span> <span class="CharLit">'o'</span> <span class="Keyword">and</span> <span class="Identifier">value</span><span class="Punctuation">[</span><span class="Punctuation">]</span> <span class="Operator">==</span> <span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">5</span><span class="Punctuation">,</span> <span class="DecNumber">7</span><span class="Punctuation">,</span> <span class="DecNumber">9</span><span class="Punctuation">]</span><span class="Punctuation">)</span> <span class="Keyword">or</span> <span class="Punctuation">(</span><span class="Identifier">k</span> <span class="Operator">==</span> <span class="CharLit">'e'</span> <span class="Keyword">and</span> <span class="Identifier">value</span><span class="Punctuation">[</span><span class="Punctuation">]</span> <span class="Operator">==</span> <span class="Punctuation">[</span><span class="DecNumber">2</span><span class="Punctuation">,</span> <span class="DecNumber">4</span><span class="Punctuation">,</span> <span class="DecNumber">6</span><span class="Punctuation">,</span> <span class="DecNumber">8</span><span class="Punctuation">]</span><span class="Punctuation">)</span>  </pre>

</dd>

</dl></div>
<div class="section" id="18">
<h1><a class="toc-backref" href="#18">Templates</a></h1>
<dl class="item">
<a id="withFound.t,StashTable[K,V,Capacity],K,Index,untyped"></a>
<dt><pre><span class="Keyword">template</span> <a href="#withFound.t%2CStashTable%5BK%2CV%2CCapacity%5D%2CK%2CIndex%2Cuntyped"><span class="Identifier">withFound</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">;</span> <span class="Identifier">V</span><span class="Other">;</span> <span class="Identifier">Capacity</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">stash</span><span class="Other">:</span> <a href="stashtable.html#StashTable"><span class="Identifier">StashTable</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity</span><span class="Other">]</span><span class="Other">;</span> <span class="Identifier">thekey</span><span class="Other">:</span> <span class="Identifier">K</span><span class="Other">;</span>
                                   <span class="Identifier">theindex</span><span class="Other">:</span> <a href="stashtable.html#Index"><span class="Identifier">Index</span></a><span class="Other">;</span> <span class="Identifier">body</span><span class="Other">:</span> <span class="Identifier">untyped</span><span class="Other">)</span></pre></dt>
<dd>

<p>Retrieves pointer to the value as variable <tt class="docutils literal"><span class="pre">value</span></tt> at <tt class="docutils literal"><span class="pre">theindex</span></tt>. <tt class="docutils literal"><span class="pre">thekey</span></tt> must also be given to ensure that the given Index is still holding the putative item.</p>
<p>Item is locked and value can be modified in the scope of <tt class="docutils literal"><span class="pre">withFound</span></tt> call.</p>
<p>On one hand this is faster operation than <tt class="docutils literal"><span class="pre">withValue</span></tt> because there's no need to find the Index, but on other hand there's greater probability that the item was deleted and reinserted to other Index by other thread(s) since the Index was retrieved.</p>

<p><strong class="examples_text">Example:</strong></p>
<pre class="listing"><span class="Keyword">type</span><span class="Whitespace"> </span><span class="Identifier">Item</span><span class="Whitespace"> </span><span class="Operator">=</span><span class="Whitespace"> </span><span class="Keyword">tuple</span><span class="Punctuation">[</span><span class="Identifier">name</span><span class="Punctuation">:</span><span class="Whitespace"> </span><span class="Identifier">char</span><span class="Punctuation">,</span><span class="Whitespace"> </span><span class="Identifier">uid</span><span class="Punctuation">:</span><span class="Whitespace"> </span><span class="Identifier">int</span><span class="Punctuation">]</span><span class="Whitespace">
</span><span class="Keyword">let</span><span class="Whitespace"> </span><span class="Identifier">stash</span><span class="Whitespace"> </span><span class="Operator">=</span><span class="Whitespace"> </span><span class="Identifier">newStashTable</span><span class="Punctuation">[</span><span class="Identifier">int</span><span class="Punctuation">,</span><span class="Whitespace"> </span><span class="Identifier">Item</span><span class="Punctuation">,</span><span class="Whitespace"> </span><span class="DecNumber">8</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Whitespace">
</span><span class="Keyword">let</span><span class="Whitespace"> </span><span class="Identifier">key</span><span class="Whitespace"> </span><span class="Operator">=</span><span class="Whitespace"> </span><span class="DecNumber">42</span><span class="Whitespace">
</span><span class="Identifier">stash</span><span class="Punctuation">[</span><span class="Identifier">key</span><span class="Punctuation">]</span><span class="Whitespace"> </span><span class="Operator">=</span><span class="Whitespace"> </span><span class="Punctuation">(</span><span class="CharLit">&apos;a&apos;</span><span class="Punctuation">,</span><span class="Whitespace"> </span><span class="DecNumber">555</span><span class="Punctuation">)</span><span class="Whitespace">
</span><span class="Keyword">let</span><span class="Whitespace"> </span><span class="Identifier">index</span><span class="Whitespace"> </span><span class="Operator">=</span><span class="Whitespace"> </span><span class="Identifier">stash</span><span class="Operator">.</span><span class="Identifier">findIndex</span><span class="Punctuation">(</span><span class="Identifier">key</span><span class="Punctuation">)</span><span class="Whitespace">
</span><span class="Identifier">stash</span><span class="Operator">.</span><span class="Identifier">withFound</span><span class="Punctuation">(</span><span class="Identifier">key</span><span class="Whitespace"> </span><span class="Punctuation">,</span><span class="Whitespace"> </span><span class="Identifier">index</span><span class="Punctuation">)</span><span class="Punctuation">:</span><span class="Whitespace">
  </span><span class="Comment"># block is executed only if ``key`` in ``index``</span><span class="Whitespace">
  </span><span class="Identifier">value</span><span class="Operator">.</span><span class="Identifier">name</span><span class="Whitespace"> </span><span class="Operator">=</span><span class="Whitespace"> </span><span class="CharLit">&apos;u&apos;</span><span class="Whitespace">
  </span><span class="Identifier">value</span><span class="Operator">.</span><span class="Identifier">uid</span><span class="Whitespace"> </span><span class="Operator">=</span><span class="Whitespace"> </span><span class="DecNumber">1000</span><span class="Whitespace">
</span><span class="Identifier">stash</span><span class="Operator">.</span><span class="Identifier">withFound</span><span class="Punctuation">(</span><span class="DecNumber">42</span><span class="Whitespace"> </span><span class="Punctuation">,</span><span class="Whitespace"> </span><span class="FloatNumber">0.</span><span class="Identifier">Index</span><span class="Punctuation">)</span><span class="Punctuation">:</span><span class="Whitespace"> </span><span class="Identifier">doAssert</span><span class="Whitespace"> </span><span class="Identifier">value</span><span class="Operator">.</span><span class="Identifier">name</span><span class="Whitespace"> </span><span class="Operator">==</span><span class="Whitespace"> </span><span class="CharLit">&apos;u&apos;</span></pre>

</dd>
<a id="withValue.t,StashTable[K,V,Capacity],K,untyped,untyped"></a>
<dt><pre><span class="Keyword">template</span> <a href="#withValue.t%2CStashTable%5BK%2CV%2CCapacity%5D%2CK%2Cuntyped%2Cuntyped"><span class="Identifier">withValue</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">;</span> <span class="Identifier">V</span><span class="Other">;</span> <span class="Identifier">Capacity</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">stash</span><span class="Other">:</span> <a href="stashtable.html#StashTable"><span class="Identifier">StashTable</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity</span><span class="Other">]</span><span class="Other">;</span> <span class="Identifier">thekey</span><span class="Other">:</span> <span class="Identifier">K</span><span class="Other">;</span>
                                   <span class="Identifier">body1</span><span class="Other">,</span> <span class="Identifier">body2</span><span class="Other">:</span> <span class="Identifier">untyped</span><span class="Other">)</span></pre></dt>
<dd>

<p>Retrieves pointer to the value as variable <tt class="docutils literal"><span class="pre">value</span></tt> for <tt class="docutils literal"><span class="pre">thekey</span></tt>. Item is locked and <tt class="docutils literal"><span class="pre">value</span></tt> can be modified in the scope of <tt class="docutils literal"><span class="pre">withValue</span></tt> call.</p>
<p><strong>Example:</strong></p>
<pre class="listing"><span class="Identifier">stashTable</span><span class="Operator">.</span><span class="Identifier">withValue</span><span class="Punctuation">(</span><span class="Identifier">key</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
  <span class="Comment"># block is executed only if ``key`` in ``stashTable``</span>
  <span class="Identifier">value</span><span class="Operator">.</span><span class="Identifier">name</span> <span class="Operator">=</span> <span class="Identifier">username</span>
  <span class="Identifier">value</span><span class="Operator">.</span><span class="Identifier">uid</span> <span class="Operator">=</span> <span class="DecNumber">1000</span>
<span class="Keyword">do</span><span class="Punctuation">:</span>
  <span class="Comment"># block is executed when ``key`` not in ``stashTable``</span>
  <span class="Keyword">raise</span> <span class="Identifier">newException</span><span class="Punctuation">(</span><span class="Identifier">KeyError</span><span class="Punctuation">,</span> <span class="StringLit">&quot;Key not found&quot;</span><span class="Punctuation">)</span></pre>

</dd>
<a id="withValue.t,StashTable[K,V,Capacity],K,untyped"></a>
<dt><pre><span class="Keyword">template</span> <a href="#withValue.t%2CStashTable%5BK%2CV%2CCapacity%5D%2CK%2Cuntyped"><span class="Identifier">withValue</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">;</span> <span class="Identifier">V</span><span class="Other">;</span> <span class="Identifier">Capacity</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">stash</span><span class="Other">:</span> <a href="stashtable.html#StashTable"><span class="Identifier">StashTable</span></a><span class="Other">[</span><span class="Identifier">K</span><span class="Other">,</span> <span class="Identifier">V</span><span class="Other">,</span> <span class="Identifier">Capacity</span><span class="Other">]</span><span class="Other">;</span> <span class="Identifier">thekey</span><span class="Other">:</span> <span class="Identifier">K</span><span class="Other">;</span>
                                   <span class="Identifier">body</span><span class="Other">:</span> <span class="Identifier">untyped</span><span class="Other">)</span></pre></dt>
<dd>

Retrieves pointer to the value as variable <tt class="docutils literal"><span class="pre">value</span></tt> for <tt class="docutils literal"><span class="pre">thekey</span></tt>. Item is locked and <tt class="docutils literal"><span class="pre">value</span></tt> can be modified in the scope of <tt class="docutils literal"><span class="pre">withValue</span></tt> call.

</dd>

</dl></div>

  </div>
</div>

    <div class="row">
      <div class="twelve-columns footer">
        <span class="nim-sprite"></span>
        <br/>
        <small style="color: var(--hint);">Made with Nim. Generated: 2021-04-14 09:51:35 UTC</small>
      </div>
    </div>
  </div>
</div>

</body>
</html>
